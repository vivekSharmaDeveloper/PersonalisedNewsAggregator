name: ğŸ” Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'

jobs:
  # Validate PR Title and Description
  pr-validation:
    name: ğŸ“ PR Title & Description Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate PR Title
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          chore
          ci
          build
        requireScope: false
        
    - name: ğŸ“‹ Check PR Description
      run: |
        if [ -z "${{ github.event.pull_request.body }}" ]; then
          echo "âŒ PR description is required"
          exit 1
        else
          echo "âœ… PR description provided"
        fi

  # Quick Tests for Fast Feedback
  quick-tests:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          server/package-lock.json
          client/package-lock.json
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd server && npm ci
        cd ../client && npm ci
    
    - name: ğŸ§¹ Lint Check
      run: |
        cd server && npm run lint
        cd ../client && npm run lint
        
    - name: ğŸ—ï¸ Build Check
      run: |
        cd client && npm run build
        
    - name: ğŸ§ª Quick Tests
      run: |
        cd server && npm run test:unit

  # Changed Files Analysis
  changed-files:
    name: ğŸ“Š Analyze Changed Files
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ” Get Changed Files
      id: changed-files
      uses: tj-actions/changed-files@v46
      with:
        files_yaml: |
          backend:
            - 'server/**'
          frontend:
            - 'client/**'
          config:
            - '*.json'
            - '*.yml'
            - '*.yaml'
          docs:
            - '*.md'
            - 'docs/**'
            
    - name: ğŸ“Š Report Changes
      run: |
        echo "## ğŸ“ Changed Files Summary" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.changed-files.outputs.backend_any_changed }}" == "true" ]; then
          echo "ğŸ”§ **Backend Changes:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "Files: ${{ steps.changed-files.outputs.backend_all_changed_files }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "true" ]; then
          echo "ğŸ¨ **Frontend Changes:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "Files: ${{ steps.changed-files.outputs.frontend_all_changed_files }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.changed-files.outputs.config_any_changed }}" == "true" ]; then
          echo "âš™ï¸ **Config Changes:** Yes" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.changed-files.outputs.docs_any_changed }}" == "true" ]; then
          echo "ğŸ“š **Documentation Changes:** Yes" >> $GITHUB_STEP_SUMMARY
        fi

  # Security Check for Dependencies
  security-check:
    name: ğŸ”’ Security & Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ” Check for Secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
        
    - name: ğŸ”’ Audit Dependencies (Server)
      run: |
        cd server
        npm audit --audit-level moderate
        
    - name: ğŸ”’ Audit Dependencies (Client)
      run: |
        cd client
        npm audit --audit-level moderate

  # Performance Impact Check
  performance-check:
    name: âš¡ Performance Impact
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'client/')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd client
        npm ci
        
    - name: ğŸ—ï¸ Build and Analyze Bundle
      run: |
        cd client
        npm run build
        
    - name: ğŸ“Š Bundle Size Analysis
      run: |
        cd client
        echo "## ğŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
        echo "Build completed successfully âœ…" >> $GITHUB_STEP_SUMMARY
        
        if [ -d ".next/static" ]; then
          echo "**Static Assets:**" >> $GITHUB_STEP_SUMMARY
          du -sh .next/static/* >> $GITHUB_STEP_SUMMARY
        fi

  # Code Quality Gates
  quality-gates:
    name: ğŸ¯ Quality Gates
    runs-on: ubuntu-latest
    needs: [pr-validation, quick-tests, security-check]
    
    steps:
    - name: âœ… All Checks Passed
      run: |
        echo "## ğŸ‰ Quality Gates Status" >> $GITHUB_STEP_SUMMARY
        echo "âœ… PR Validation: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Quick Tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Security Check: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ready for Review" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ¯ PR Ready for Review
      run: |
        echo "ğŸš€ This PR has passed all quality gates!"
        echo "ğŸ“‹ Code follows standards"
        echo "ğŸ§ª Tests are passing"
        echo "ğŸ”’ No security issues detected"
        echo "âœ¨ Ready for human review"
